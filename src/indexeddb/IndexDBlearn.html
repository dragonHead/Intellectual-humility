<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>IndexDB Learn</title>
    </head>
    <body>
        <h1>IndexDb Learn</h1>
        <script>
            if (window.indexedDB) {
                const INDEXDB_VERSION = 1;
                let openRequest = window.indexedDB.open("store", INDEXDB_VERSION);

                // クライアントがデータベースを持っていない場合にトリガーされます
                // 既存のデータベースのバージョンをチェックし、必要なら更新する:
                openRequest.onupgradeneeded = function (e) {
                    const customerData = [
                        {ssn: "444-44-4444",name: "Bill",age: 35,email: "bill@company.com",},
                        {ssn: "555-55-5555",name: "Donna",age: 32,email: "donna@home.org",},
                    ];

                    let db = e.target.result;
                    if (!db.objectStoreNames.contains("books")) {
                        const objectStore = db.createObjectStore("books", {
                            keyPath: "ssn",
                        });
                        // const objectStore = db.createObjectStore("books", { autoIncrement : true });
                        objectStore.createIndex("name", "name", {
                            unique: false,
                        });
                        objectStore.createIndex("email", "email", {
                            unique: true,
                        });
                        // データを追加する前に objectStore の作成を完了させるため、
                        // transaction oncomplete を使用します。
                        objectStore.transaction.oncomplete = function (event) {
                            // 新たに作成した objectStore に値を保存します。(初期データ)
                            var bookObjectStore = db
                                .transaction("books", "readwrite")
                                .objectStore("books");
                            for (var i in customerData) {
                                bookObjectStore.add(customerData[i]);
                            }
                        };
                    }
                };
                openRequest.onerror = function (e) {
                    console.log("Database error: " + event.target.errorCode);
                };

                // db オブジェクトを仕様してデータベースを操作します
                openRequest.onsuccess = function (e) {
                    let customerData = [
                        {
                            ssn: "444-44-4444",
                            name: "Bill",
                            age: 35,
                            email: "bill@company.com",
                        },
                        {
                            ssn: "555-55-5555",
                            name: "Donna",
                            age: 32,
                            email: "donna@home.org",
                        },
                    ];

                    let db = e.target.result;
                    // console.log("success");
                    // 第2引数の指定がない場合は、readonly
                    const transaction = db.transaction(["books"], "readwrite");
                    var objectStore = transaction.objectStore("books");

                    // delete
                    for (let i in customerData) {
                        // keyを指定する
                        var request = objectStore.delete(customerData[i].ssn);
                        request.onsuccess = function (event) {
                            console.log("delete add success");
                        };
                        request.onerror = function (event) {
                            console.log(event.target);
                        };
                    }

                    // create
                    for (let i in customerData) {
                        var request = objectStore.add(customerData[i]);
                        request.onsuccess = function (event) {
                            console.log("data add success");
                        };
                        request.onerror = function (event) {
                            console.log(event.target);
                        };
                    }

                    // select
                    // keyを指定する
                    var request = objectStore.get("444-44-4444");
                    request.onerror = function (event) {
                        // エラー処理!
                        console.log(event);
                    };
                    request.onsuccess = function (event) {
                        // request.result に対して行う処理!
                        console.log(
                            "Name for SSN 444-44-4444 is " +
                                event.target.result.name
                        );
                    };

                    // update
                    var request = objectStore.get("444-44-4444");
                    request.onerror = function (event) {
                        // エラー処理!
                    };
                    request.onsuccess = function (event) {
                        // 更新したい、古い値を取得します。
                        var data = request.result;

                        // オブジェクト内の値を、希望する値に更新します。
                        data.age = 42;

                        // 更新したオブジェクトを、データベースに書き戻します。
                        var requestUpdate = objectStore.put(data);
                        requestUpdate.onerror = function (event) {
                            // エラーが発生した場合の処理
                        };
                        requestUpdate.onsuccess = function (event) {
                            // 成功 - データを更新しました!
                        };
                    };

                    // カーソルを使用する
                    var books = [];
                    objectStore.openCursor().onsuccess = function (event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            books.push(cursor.value);
                            cursor.continue();
                        } else {
                            console.log("Got all books: ", books);
                        }
                    };

                    // indexを使用した検索
                    var index = objectStore.index("name");
                    // index.get("Donna").onsuccess = function(event) {
                    // 	alert("Donna's SSN is " + event.target.result.ssn);
                    // };

                    // 顧客レコードのオブジェクト全体を得るために、ノーマルカーソルを使用します。
                    index.openCursor().onsuccess = function (event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // cursor.key は "Bill" のような名前、cursor.value はオブジェクト全体です。
                            console.log(
                                "Name: " +
                                    cursor.key +
                                    ", SSN: " +
                                    cursor.value.ssn +
                                    ", email: " +
                                    cursor.value.email
                            );
                            cursor.continue();
                        }
                    };

                    // 顧客レコードのオブジェクトのキーを得るために、キーカーソルを使用します。
                    index.openKeyCursor().onsuccess = function (event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // cursor.key は "Bill" のような名前、cursor.value は SSN です。
                            // 保存されたオブジェクトの他の部分を直接取得する方法はありません。
                            console.log(
                                "Name: " + cursor.key + ", SSN: " + cursor.primaryKey
                            );
                            cursor.continue();
                        }
                    };

                    // "Donna" にのみマッチします。
                    var singleKeyRange = IDBKeyRange.only("Donna");

                    // "Bill" より先のすべてにマッチします。"Bill" を含みます。
                    var lowerBoundKeyRange = IDBKeyRange.lowerBound("Bill");

                    // "Bill" より先のすべてにマッチします。ただし "Bill" は含みません。
                    var lowerBoundOpenKeyRange = IDBKeyRange.lowerBound(
                        "Bill",
                        true
                    );

                    // "Donna" までのすべてにマッチします。ただし "Donna" は含みません。
                    var upperBoundOpenKeyRange = IDBKeyRange.upperBound(
                        "Donna",
                        true
                    );

                    // "Bill" から "Donna" までにマッチします。ただし "Donna" は含みません。
                    var boundKeyRange = IDBKeyRange.bound(
                        "Bill",
                        "Donna",
                        false,
                        true
                    );

                    // いずれかのキーレンジを使用するには、openCursor()/openKeyCursor() の第 1 引数として渡します。
                    index.openCursor(boundKeyRange).onsuccess = function (
                        event
                    ) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // マッチした場合の処理。
                            cursor.continue();
                        }
                    };

                    // 降順
                    objectStore.openCursor(
                        boundKeyRange,
                        "prev"
                    ).onsuccess = function (event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // 項目に対して行う処理
                            cursor.continue();
                        }
                    };

                    // 制限なし、降順
                    objectStore.openCursor(null, "prev").onsuccess = function (
                        event
                    ) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // 項目に対して行う処理
                            cursor.continue();
                        }
                    };

                    // 重複取り除く
                    index.openKeyCursor(
                        null,
                        "nextunique"
                    ).onsuccess = function (event) {
                        var cursor = event.target.result;
                        if (cursor) {
                            // 項目に対して行う処理
                            cursor.continue();
                        }
                    };

                    // すべてのデータがデータベースに追加されたときに行う処理
                    transaction.oncomplete = function (event) {
                        console.log("All done!");
                    };

                    transaction.onerror = function (event) {
                        console.log("transaction error: ", e);
                    };
                };
            }
        </script>
    </body>
</html>
